#ABUILD created by: SirAnthony, anthony at adsorbtion.org 
#----------------------------- General vars --------------------------------------
pkgname=steam
pkgver=1.0.0.35
pkgbuild=1
arch=('auto')

shortdesc="Digital distribution client - bootstrap package"

source=("http://repo.steampowered.com/${pkgname}/pool/${pkgname}/s/${pkgname}/${pkgname}_${pkgver}.tar.gz")

#----------------------------- AgiliaLinux vars --------------------------------------
tags="games games-util x86"

if [ "${ARCH}" = "i686" ]; then
adddep="bash xterm glibc-i18n libX11 libxcb libXau libXdmcp glibc-solibs cxxlibs mesa
        desktop-file-utils hicolor-icon-theme alsa-lib curl libogg pixman
        cairo dbus fontconfig freetype gdk-pixbuf glib2 pango libpng zlib
        glibc libgl flash-player"
#libjpeg-turbo gcc-libs
fi
if [ "${ARCH}" = "x86_64" ]; then
adddep="bash xterm glibc-i18n32 libX1132 libxcb32 libXau32 libXdmcp32 glibc-solibs32
        cxxlibs32 mesa32 desktop-file-utils hicolor-icon-theme alsa-lib32 libgl32 curl
        libogg32 pixman32 cairo32 dbus32 fontconfig32 freetype32 gdk-pixbuf32 glib232
        pango32 libpng32 zlib32 glibc32 libgl32"
#libjpeg-turbo32 gcc-libs32 flash-player32
fi


build(){

PRGNAM=$pkgname
VERSION=$pkgver
SRCDIR=$srcdir
PKG=$pkgdir

cd $SRCDIR

mv steam steam-${VERSION} 2>/dev/null
cd steam-${VERSION}
chown -R root:root .
chmod -R u+w,go+r-w,a+X-s .

# Move the binaries into place:
install -d -m 755 $PKG/usr/bin/
install -p -m 755 steam $PKG/usr/bin/
install -p -m 755 steamdeps $PKG/usr/bin/

# Install the desktop file plus icons:
install -d -m 755 $PKG/usr/share/applications
install -p -m 644 steam.desktop $PKG/usr/share/applications/
for size in 16 24 32 48 256 ; do
  install -d -m 755 $PKG/usr/share/icons/hicolor/${size}x${size}/apps/
  install -p -m 644 icons/${size}/steam.png \
    $PKG/usr/share/icons/hicolor/${size}x${size}/apps/
done
install -d -m 755 $PKG/usr/share/pixmaps/
install -p -m 644 icons/48/steam.png $PKG/usr/share/pixmaps/
install -p -m 644 icons/48/steam.png $PKG/usr/share/pixmaps/steam_tray.png
install -p -m 644 icons/48/steam_tray_mono.png $PKG/usr/share/pixmaps/steam_tray_mono.png

# Install the steam bootstrap:
install -d -m 755 $PKG/usr/lib/steam/
install -p -m 644 bootstraplinux_*_32.tar.xz $PKG/usr/lib/steam/

# Install udev rule for the Steam Controller:
install -d -m 755 $PKG/lib/udev/rules.d
install -p -m 644 lib/udev/rules.d/99-steam-controller-perms.rules \
  $PKG/lib/udev/rules.d/

# Add some documentation:
mkdir -p $PKG/usr/doc/$PRGNAM-$VERSION
cp -ia COPYING README steam_install_agreement.txt \
  $PKG/usr/doc/$PRGNAM-$VERSION || true

# Take care of the man page:
install -d -m 755 $PKG/usr/man/man6/
install -p -m 644 steam.6 $PKG/usr/man/man6/
gzip $PKG/usr/man/man6/steam.6

cd ${PKG}
# Apply changes to the steam script which we need on Slackware:
sed -i -e '/env bash/ a\
# --- Start Slackware mod ---\
export LD_LIBRARY_PATH=/usr/lib/seamonkey\
# Audio output goes to first "hw" device of ALSA\
export SDL_AUDIODRIVER=alsa\
#export AUDIODEV=hw\
# On window close, minimize to the system tray area:\
export STEAM_FRAME_FORCE_CLOSE=1\
# Add any custom variable exports here\
[ -f ${HOME}/.steam4slackware ] \&\& . ${HOME}/.steam4slackware\
# --- End Slackware mod ---' $PKG/usr/bin/steam 
# We need to add a symlink to /sbin/pidof in order to make it be found:
sed -i -e '/bin\/bash/{N;s#$#\nexport PATH="/usr/lib/steam/local:$PATH"#}' $PKG/usr/bin/steam 
sed -i -e 's/xterm/${TERM}/' $PKG/usr/bin/steam

# Our 'pidof' workaround:
mkdir $PKG/usr/lib/steam/local
ln -sf /sbin/pidof $PKG/usr/lib/steam/local/pidof
}
